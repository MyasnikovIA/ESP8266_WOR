<!DOCTYPE html>
<html>
<head>
    <title>VR Head Tracker - Bluetooth</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .data { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .connecting { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .controls { margin: 20px 0; }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #007bff; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-bluetooth { background: #0082fc; color: white; }
        .zero-controls { background: #e8f5e8; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 5px solid #28a745; }
        .visualization { background: #2c3e50; color: white; padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .cube-container { width: 300px; height: 300px; margin: 20px auto; perspective: 1000px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.1s ease-out; }
        .face { position: absolute; width: 300px; height: 300px; border: 3px solid #34495e; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white; background: rgba(52, 152, 219, 0.8); }
        .left { transform: rotateY(0deg) translateZ(150px); background: rgba(231, 76, 60, 0.8); }
        .right { transform: rotateY(180deg) translateZ(150px); background: rgba(52, 152, 219, 0.8); }
        .back { transform: rotateY(90deg) translateZ(150px); background: rgba(46, 204, 113, 0.8); }
        .front { transform: rotateY(-90deg) translateZ(150px); background: rgba(155, 89, 182, 0.8); }
        .top { transform: rotateX(90deg) translateZ(150px); background: rgba(241, 196, 15, 0.8); }
        .bottom { transform: rotateX(-90deg) translateZ(150px); background: rgba(230, 126, 34, 0.8); }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .data-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
        .data-label { font-weight: bold; color: #495057; margin-bottom: 5px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        h3 { color: #343a40; margin-bottom: 15px; }
        .device-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0; background: white; }
        .device-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .device-item:hover { background: #f0f8ff; }
        .device-name { font-weight: bold; }
        .device-id { font-size: 12px; color: #666; }
        .debug-info { background: #2c3e50; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .manual-connect { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 5px solid #ffc107; }
        .error-box { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 5px solid #f5c6cb; }
        .success-box { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 5px solid #c3e6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>VR Head Tracker - Bluetooth Interface</h1>
        
        <div class="status disconnected" id="status">Bluetooth Disconnected</div>
        
        <div class="data">
            <h3>Bluetooth Connection</h3>
            
            <div class="manual-connect" id="connectionInstructions">
                <p><strong>Подключение к VR Head Tracker:</strong></p>
                <ol>
                    <li>Убедитесь, что ESP32 включен и Bluetooth активен</li>
                    <li>Нажмите "Connect to VR Head"</li>
                    <li>В появившемся окне выберите "VR_Head_Hom_001"</li>
                    <li>Если устройство не видно, нажмите "Scan All Devices"</li>
                </ol>
            </div>
            
            <div class="controls">
                <button class="btn-bluetooth" id="connectBtn" onclick="connectToDevice()">
                    <span id="connectText">Connect to VR Head</span>
                    <span id="connectSpinner" style="display:none;" class="loading"></span>
                </button>
                <button class="btn-info" id="scanAllBtn" onclick="scanAllDevices()">
                    <span id="scanText">Scan All Devices</span>
                    <span id="scanSpinner" style="display:none;" class="loading"></span>
                </button>
                <button class="btn-danger" id="disconnectBtn" onclick="disconnectBluetooth()" disabled>Disconnect</button>
            </div>
            
            <div id="deviceListContainer" style="display: none; margin-top: 15px;">
                <h4>Available Bluetooth Devices:</h4>
                <div class="device-list" id="deviceList">
                    <div class="device-item" style="color: #666; font-style: italic;">
                        Scanning for devices... Please wait
                    </div>
                </div>
            </div>
            
            <div id="connectionInfo" style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; display: none;">
                <h4>Connection Information</h4>
                <p><strong>Connected Device:</strong> <span id="connectedDeviceName">-</span></p>
                <p><strong>Status:</strong> <span id="connectionStatus">-</span></p>
                <p><strong>Device ID:</strong> <span id="connectedDeviceId">-</span></p>
                <p><strong>Service UUID:</strong> <code id="serviceUUID">-</code></p>
                <p><strong>Characteristic UUID:</strong> <code id="characteristicUUID">-</code></p>
            </div>
            
            <div class="error-box" id="errorBox" style="display: none;">
                <strong>Error:</strong> <span id="errorMessage"></span>
            </div>
        </div>
        
        <div class="data">
            <h3>Sensor Readings</h3>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">Pitch</div>
                    <div class="value" id="pitch">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Roll</div>
                    <div class="value" id="roll">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Yaw</div>
                    <div class="value" id="yaw">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Relative Pitch</div>
                    <div class="value" id="relPitch">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Relative Roll</div>
                    <div class="value" id="relRoll">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Relative Yaw</div>
                    <div class="value" id="relYaw">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accumulated Pitch</div>
                    <div class="value" id="accPitch">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accumulated Roll</div>
                    <div class="value" id="accRoll">0°</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accumulated Yaw</div>
                    <div class="value" id="accYaw">0°</div>
                </div>
            </div>
        </div>

        <div class="zero-controls">
            <h3>Zero Point Control</h3>
            <button class="btn-success" onclick="sendCommand('SET_ZERO')" id="setZeroBtn" disabled>Set Zero Point</button>
            <button class="btn-warning" onclick="sendCommand('RESET_ZERO')" id="resetZeroBtn" disabled>Reset Zero</button>
            <button class="btn-danger" onclick="sendCommand('RESET_ANGLES')" id="resetAnglesBtn" disabled>Reset All Angles</button>
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
                <div style="font-size: 14px; color: #666;">
                    <strong>Zero Point:</strong> <span id="zeroStatus" style="color: #dc3545; font-weight: bold;">Not Set</span>
                </div>
                <div style="font-size: 12px; color: #888; margin-top: 8px;">
                    Zero point allows you to set a reference position. Relative angles show deviation from zero point.
                    Accumulated angles show total rotation without limits (can exceed 360°).
                </div>
            </div>
        </div>

        <div class="visualization">
            <h3 style="color: white; text-align: center;">3D Platform Visualization</h3>
            <div class="cube-container">
                <div class="cube" id="cube">
                    <div class="face front">FRONT</div>
                    <div class="face back">BACK</div>
                    <div class="face left">LEFT</div>
                    <div class="face right">RIGHT</div>
                    <div class="face top">TOP</div>
                    <div class="face bottom">BOTTOM</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <h3>Sensor Controls</h3>
            <button class="btn-primary" onclick="sendCommand('GET_DATA')" id="getDataBtn" disabled>Get Sensor Data</button>
            <button class="btn-warning" onclick="sendCommand('RECALIBRATE')" id="recalibrateBtn" disabled>Recalibrate</button>
            <button class="btn-info" onclick="sendCommand('STATUS')" id="statusBtn" disabled>Get Status</button>
            <button class="btn-warning" onclick="sendCommand('LED ON')" id="ledOnBtn" disabled>LED On</button>
            <button class="btn-warning" onclick="sendCommand('LED OFF')" id="ledOffBtn" disabled>LED Off</button>
            <button class="btn-info" onclick="sendCommand('TEMP')" id="tempBtn" disabled>Get Temperature</button>
            <button class="btn-info" onclick="sendCommand('DATA')" id="dataBtn" disabled>Get Raw Data</button>
        </div>
        
        <div class="data">
            <h3>Last Message</h3>
            <div id="lastMessage" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; min-height: 20px; max-height: 200px; overflow-y: auto;">No data received</div>
        </div>
        
        <div class="data">
            <h3>Instructions & Troubleshooting</h3>
            <div style="background: #e9ecef; padding: 15px; border-radius: 5px;">
                <p><strong>Как подключиться:</strong></p>
                <ol>
                    <li>Нажмите "Connect to VR Head" для прямого подключения</li>
                    <li>В появившемся окне выберите "VR_Head_Hom_001"</li>
                    <li>Если устройство не видно, нажмите "Scan All Devices"</li>
                    <li>После подключения данные начнут автоматически обновляться</li>
                </ol>
                
                <p><strong>Требования:</strong></p>
                <ul>
                    <li>Браузер Chrome/Edge/Opera на Windows 10/11, macOS или Android</li>
                    <li>Bluetooth 4.0+ адаптер</li>
                    <li>ESP32 с загруженным скетчем VR Head Tracker</li>
                </ul>
                
                <p><strong>Если не работает:</strong></p>
                <ol>
                    <li>Проверьте, что ESP32 включен и светодиод мигает</li>
                    <li>Перезагрузите ESP32</li>
                    <li>Перезагрузите страницу в браузере</li>
                    <li>Убедитесь что Bluetooth включен на компьютере</li>
                    <li>Попробуйте другой браузер (Chrome рекомендуется)</li>
                    <li>Убедитесь что страница открыта по HTTPS или localhost</li>
                </ol>
                
                <div style="margin-top: 10px;">
                    <button class="btn-info" onclick="toggleDebug()" id="debugBtn">Show Debug Info</button>
                    <button class="btn-warning" onclick="clearLog()" style="margin-left: 10px;">Clear Log</button>
                </div>
            </div>
        </div>
        
        <div class="debug-info" id="debugInfo" style="display: none;">
            <h4 style="color: white; margin-top: 0;">Debug Information</h4>
            <div id="debugContent" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // Bluetooth variables
        let bluetoothDevice = null;
        let bluetoothServer = null;
        let bluetoothService = null;
        let bluetoothCharacteristic = null;
        
        // UUIDs - ДОЛЖНЫ СОВПАДАТЬ С СКЕТЧЕМ!
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        
        // UI elements
        let statusDiv = document.getElementById('status');
        let lastMessageDiv = document.getElementById('lastMessage');
        let cube = document.getElementById('cube');
        let zeroStatusSpan = document.getElementById('zeroStatus');
        let connectedDeviceNameSpan = document.getElementById('connectedDeviceName');
        let connectionStatusSpan = document.getElementById('connectionStatus');
        let connectedDeviceIdSpan = document.getElementById('connectedDeviceId');
        let serviceUUIDEl = document.getElementById('serviceUUID');
        let characteristicUUIDEl = document.getElementById('characteristicUUID');
        let deviceListContainer = document.getElementById('deviceListContainer');
        let deviceList = document.getElementById('deviceList');
        let connectionInfo = document.getElementById('connectionInfo');
        let errorBox = document.getElementById('errorBox');
        let errorMessage = document.getElementById('errorMessage');
        let debugInfo = document.getElementById('debugInfo');
        let debugContent = document.getElementById('debugContent');
        let connectionInstructions = document.getElementById('connectionInstructions');
        
        // Enable/disable control buttons
        function updateButtonStates(connected) {
            const buttons = [
                'setZeroBtn', 'resetZeroBtn', 'resetAnglesBtn',
                'getDataBtn', 'recalibrateBtn', 'statusBtn',
                'ledOnBtn', 'ledOffBtn', 'disconnectBtn',
                'tempBtn', 'dataBtn'
            ];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = !connected;
                }
            });
            
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('scanAllBtn').disabled = connected;
        }
        
        // Show loading spinner
        function showLoading(buttonId, show) {
            const textElement = document.getElementById(buttonId + 'Text');
            const spinnerElement = document.getElementById(buttonId + 'Spinner');
            
            if (textElement) textElement.style.display = show ? 'none' : 'inline';
            if (spinnerElement) spinnerElement.style.display = show ? 'inline-block' : 'none';
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.style.display = 'block';
            logDebug('ERROR: ' + message);
        }
        
        // Hide error message
        function hideError() {
            errorBox.style.display = 'none';
        }
        
        // Connect to specific VR Head device
        async function connectToDevice() {
            try {
                hideError();
                showLoading('connect', true);
                statusDiv.textContent = 'Connecting to VR Head...';
                statusDiv.className = 'status connecting';
                
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API is not supported in this browser. Please use Chrome, Edge, or Opera.');
                }
                
                logDebug('Requesting Bluetooth device with service UUID: ' + SERVICE_UUID);
                
                // ВАЖНО: указываем UUID службы в optionalServices
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{
                        name: 'VR_Head_Hom_001'  // Фильтр по имени устройства
                    }],
                    optionalServices: [SERVICE_UUID]  // ОБЯЗАТЕЛЬНО добавляем UUID службы
                });
                
                logDebug(`Device selected: ${bluetoothDevice.name || 'Unnamed'} (ID: ${bluetoothDevice.id})`);
                
                statusDiv.textContent = 'Connecting to GATT server...';
                
                // Add event listener for disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                // Connect to GATT server
                bluetoothServer = await bluetoothDevice.gatt.connect();
                logDebug('GATT server connected');
                
                statusDiv.textContent = 'Getting service...';
                
                // Get the service - теперь используем правильный UUID
                bluetoothService = await bluetoothServer.getPrimaryService(SERVICE_UUID);
                logDebug('Service found: ' + SERVICE_UUID);
                
                statusDiv.textContent = 'Getting characteristic...';
                
                // Get the characteristic
                bluetoothCharacteristic = await bluetoothService.getCharacteristic(CHARACTERISTIC_UUID);
                logDebug('Characteristic found: ' + CHARACTERISTIC_UUID);
                
                statusDiv.textContent = 'Enabling notifications...';
                
                // Enable notifications
                await bluetoothCharacteristic.startNotifications();
                logDebug('Notifications enabled');
                
                // Set up notification handler
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                
                // Update UI
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectedDeviceNameSpan.textContent = bluetoothDevice.name || 'VR Head Tracker';
                connectedDeviceIdSpan.textContent = bluetoothDevice.id;
                connectionStatusSpan.textContent = 'Connected';
                serviceUUIDEl.textContent = SERVICE_UUID;
                characteristicUUIDEl.textContent = CHARACTERISTIC_UUID;
                connectionInfo.style.display = 'block';
                connectionInstructions.style.display = 'none';
                
                // Enable buttons
                updateButtonStates(true);
                
                // Request initial data
                setTimeout(() => sendCommand('GET_DATA'), 500);
                
                showNotification('Successfully connected to VR Head Tracker!', 'success');
                logDebug('Connection established successfully');
                
            } catch (error) {
                console.error('Bluetooth connection error:', error);
                logDebug('Connection failed: ' + error.message);
                
                if (error.name === 'NotFoundError') {
                    statusDiv.textContent = 'Device not found';
                    showError('VR Head device "VR_Head_Hom_001" not found. Make sure: 1. ESP32 is powered on, 2. Bluetooth is advertising, 3. Device name is correct.');
                } else if (error.name === 'SecurityError') {
                    statusDiv.textContent = 'Permission denied';
                    showError('Bluetooth permission denied. Please allow Bluetooth access in your browser.');
                } else if (error.name === 'NetworkError') {
                    statusDiv.textContent = 'Connection failed';
                    showError('Connection failed. Device may be out of range or not responding.');
                } else if (error.name === 'InvalidStateError') {
                    statusDiv.textContent = 'Already connected';
                    showError('Already connected to a Bluetooth device.');
                } else {
                    statusDiv.textContent = 'Connection error';
                    showError('Failed to connect: ' + error.message);
                }
                
                statusDiv.className = 'status disconnected';
                
                // Clean up on error
                bluetoothDevice = null;
                bluetoothServer = null;
                bluetoothService = null;
                bluetoothCharacteristic = null;
                
            } finally {
                showLoading('connect', false);
            }
        }
        
        // Scan all Bluetooth devices
        async function scanAllDevices() {
            try {
                hideError();
                showLoading('scan', true);
                deviceList.innerHTML = '';
                deviceListContainer.style.display = 'block';
                
                logDebug('Scanning for all Bluetooth devices...');
                
                // Request ALL Bluetooth devices
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: []  // Не запрашиваем сервисы заранее
                });
                
                logDebug(`Found device: ${device.name || 'Unnamed'} (ID: ${device.id})`);
                
                // Show the device in the list
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.innerHTML = `
                    <div class="device-name">${device.name || 'Unnamed Device'}</div>
                    <div class="device-id">ID: ${device.id}</div>
                    <div style="font-size: 11px; color: #888; margin-top: 5px;">
                        To connect to VR Head, use "Connect to VR Head" button
                    </div>
                `;
                
                deviceList.appendChild(deviceItem);
                
                showNotification('Device found: ' + (device.name || 'Unnamed'), 'info');
                
            } catch (error) {
                console.error('Scan error:', error);
                if (error.name !== 'NotFoundError') {
                    showError('Scan error: ' + error.message);
                }
            } finally {
                showLoading('scan', false);
            }
        }
        
        // Handle Bluetooth data reception
        function handleBluetoothData(event) {
            try {
                const value = event.target.value;
                const decoder = new TextDecoder('utf-8');
                const data = decoder.decode(value);
                
                logDebug('Received: ' + data.substring(0, 100) + (data.length > 100 ? '...' : ''));
                lastMessageDiv.textContent = data;
                lastMessageDiv.scrollTop = lastMessageDiv.scrollHeight;
                
                // Parse sensor data
                if (data.includes('PITCH:') && data.includes('ROLL:') && data.includes('YAW:')) {
                    parseSensorData(data);
                }
                
                // Parse special messages
                parseSpecialMessages(data);
                
            } catch (error) {
                console.error('Error processing Bluetooth data:', error);
                logDebug('Error processing data: ' + error.message);
            }
        }
        
        // Parse sensor data
        function parseSensorData(data) {
            try {
                const pitchMatch = data.match(/PITCH:([-\d.]+)/);
                const rollMatch = data.match(/ROLL:([-\d.]+)/);
                const yawMatch = data.match(/YAW:([-\d.]+)/);
                const relPitchMatch = data.match(/REL_PITCH:([-\d.]+)/);
                const relRollMatch = data.match(/REL_ROLL:([-\d.]+)/);
                const relYawMatch = data.match(/REL_YAW:([-\d.]+)/);
                const accPitchMatch = data.match(/ACC_PITCH:([-\d.]+)/);
                const accRollMatch = data.match(/ACC_ROLL:([-\d.]+)/);
                const accYawMatch = data.match(/ACC_YAW:([-\d.]+)/);
                const zeroSetMatch = data.match(/ZERO_SET:(true|false)/);
                
                const updateValue = (elementId, value, match) => {
                    if (match) {
                        const numValue = parseFloat(match[1]);
                        document.getElementById(elementId).textContent = numValue.toFixed(1) + '°';
                        return numValue;
                    }
                    return null;
                };
                
                const pitch = updateValue('pitch', 'Pitch', pitchMatch);
                const roll = updateValue('roll', 'Roll', rollMatch);
                const yaw = updateValue('yaw', 'Yaw', yawMatch);
                updateValue('relPitch', 'Rel Pitch', relPitchMatch);
                updateValue('relRoll', 'Rel Roll', relRollMatch);
                updateValue('relYaw', 'Rel Yaw', relYawMatch);
                updateValue('accPitch', 'Acc Pitch', accPitchMatch);
                updateValue('accRoll', 'Acc Roll', accRollMatch);
                updateValue('accYaw', 'Acc Yaw', accYawMatch);
                
                if (zeroSetMatch) {
                    const zeroSet = zeroSetMatch[1] === 'true';
                    zeroStatusSpan.textContent = zeroSet ? 'Set' : 'Not Set';
                    zeroStatusSpan.style.color = zeroSet ? '#28a745' : '#dc3545';
                }
                
                if (pitch !== null && roll !== null && yaw !== null) {
                    update3DVisualization(pitch, roll, yaw);
                }
                
            } catch (error) {
                console.error('Error parsing sensor data:', error);
                logDebug('Parse error: ' + error.message);
            }
        }
        
        // Parse special messages
        function parseSpecialMessages(data) {
            if (data === 'ZERO_POINT_SET' || data.startsWith('ZERO_SET:')) {
                zeroStatusSpan.textContent = 'Set';
                zeroStatusSpan.style.color = '#28a745';
                showNotification('Zero point set successfully', 'success');
            }
            if (data === 'ZERO_POINT_RESET' || data === 'ZERO_RESET') {
                zeroStatusSpan.textContent = 'Not Set';
                zeroStatusSpan.style.color = '#dc3545';
                showNotification('Zero point reset', 'info');
            }
            if (data === 'RECALIBRATION_COMPLETE') {
                showNotification('Recalibration complete', 'success');
            }
            if (data === 'ANGLES_RESET') {
                showNotification('All angles reset', 'info');
            }
            if (data === 'LED_ON') {
                showNotification('LED turned on', 'info');
            }
            if (data === 'LED_OFF') {
                showNotification('LED turned off', 'info');
            }
            if (data.includes('STATUS:')) {
                showNotification('Device status received', 'info');
            }
            if (data.includes('TEMPERATURE:')) {
                showNotification('Temperature data received', 'info');
            }
            if (data.includes('RAW:') || data.includes('ACCEL:') || data.includes('GYRO:')) {
                showNotification('Raw sensor data received', 'info');
            }
        }
        
        // Handle disconnection
        function onDisconnected() {
            console.log('Bluetooth device disconnected');
            statusDiv.textContent = 'Disconnected';
            statusDiv.className = 'status disconnected';
            connectionStatusSpan.textContent = 'Disconnected';
            updateButtonStates(false);
            connectionInstructions.style.display = 'block';
            showNotification('Bluetooth disconnected', 'error');
            logDebug('Device disconnected');
            
            // Clean up
            bluetoothDevice = null;
            bluetoothServer = null;
            bluetoothService = null;
            bluetoothCharacteristic = null;
            
            // Try to reconnect after 5 seconds
            setTimeout(() => {
                if (!bluetoothDevice) {
                    logDebug('Attempting to reconnect...');
                    connectToDevice();
                }
            }, 5000);
        }
        
        // Disconnect from Bluetooth
        function disconnectBluetooth() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            onDisconnected();
        }
        
        // Send command to Bluetooth device
        async function sendCommand(command) {
            if (bluetoothCharacteristic) {
                try {
                    const encoder = new TextEncoder('utf-8');
                    const data = encoder.encode(command);
                    await bluetoothCharacteristic.writeValue(data);
                    logDebug('Command sent: ' + command);
                    showNotification('Command sent: ' + command, 'info');
                } catch (error) {
                    console.error('Error sending command:', error);
                    showNotification('Failed to send command: ' + error.message, 'error');
                    logDebug('Send error: ' + error.message);
                }
            } else {
                showNotification('Not connected to Bluetooth device', 'error');
            }
        }
        
        // Update 3D visualization
        function update3DVisualization(pitch, roll, yaw) {
            cube.style.transform = `rotateX(${roll}deg) rotateY(${yaw}deg) rotateZ(${pitch}deg)`;
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Debug logging
        function logDebug(message) {
            console.log('[DEBUG]', message);
            if (debugContent) {
                const time = new Date().toLocaleTimeString();
                debugContent.innerHTML += `[${time}] ${message}<br>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        // Toggle debug info
        function toggleDebug() {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            const debugBtn = document.getElementById('debugBtn');
            debugBtn.textContent = debugInfo.style.display === 'none' ? 'Show Debug Info' : 'Hide Debug Info';
        }
        
        // Clear log
        function clearLog() {
            if (debugContent) {
                debugContent.innerHTML = '';
            }
            lastMessageDiv.textContent = 'Log cleared';
        }
        
        // Initialize
        window.addEventListener('load', function() {
            // Check for Web Bluetooth support
            if (!navigator.bluetooth) {
                const errorMsg = 'Web Bluetooth API is not available. Please use Chrome, Edge, or Opera on Windows 10/11, macOS, or Android.';
                showError(errorMsg);
                statusDiv.textContent = 'Browser not supported';
                logDebug(errorMsg);
            } else {
                logDebug('Web Bluetooth API is supported');
                logDebug('Service UUID: ' + SERVICE_UUID);
                logDebug('Characteristic UUID: ' + CHARACTERISTIC_UUID);
                logDebug('Page loaded successfully');
            }
            
            // Initial button state
            updateButtonStates(false);
            
            // Add CSS for animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Auto-connect on page load (for testing)
            // setTimeout(() => {
            //     if (!bluetoothDevice) {
            //         logDebug('Attempting auto-connect...');
            //         connectToDevice();
            //     }
            // }, 1000);
        });
    </script>
</body>
</html>