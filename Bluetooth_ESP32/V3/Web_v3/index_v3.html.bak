<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 MPU6050 BLE - 3D VR Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .header {
            grid-column: 1 / -1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status.scanning {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .control-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .vr-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .visualization-panel {
            grid-column: 2;
            grid-row: 2;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin: 5px 0;
        }
        
        .btn:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover:not(:disabled) {
            background-color: #d68910;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .data-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .data-unit {
            font-size: 14px;
            color: #6c757d;
            margin-left: 5px;
        }
        
        .log-container {
            margin-top: 20px;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f8f9fa;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .log-time {
            color: #7f8c8d;
            min-width: 80px;
        }
        
        .log-message {
            flex: 1;
        }
        
        .log-sent {
            color: #3498db;
        }
        
        .log-received {
            color: #2ecc71;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .vr-view {
            flex: 1;
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        #vrScene {
            width: 100%;
            height: 100%;
        }
        
        .vr-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        
        .vr-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .vr-control-btn {
            flex: 1;
            min-width: 120px;
        }
        
        .zero-controls {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 5px solid #28a745;
        }
        
        .zero-status {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            text-align: center;
        }
        
        .zero-status.set {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .zero-status.not-set {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        
        .connection-controls {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 5px solid #3498db;
        }
        
        .sensor-values {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .sensor-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .sensor-title {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .sensor-number {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .indicator.online {
            background-color: #4cd964;
            animation: pulse 2s infinite;
        }
        
        .indicator.offline {
            background-color: #ff3b30;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                height: auto;
            }
            
            .visualization-panel {
                grid-column: 1;
                grid-row: 3;
                height: 500px;
            }
            
            .control-panel, .vr-panel {
                grid-column: 1;
            }
            
            .control-panel {
                grid-row: 2;
            }
            
            .vr-panel {
                grid-row: 4;
            }
        }
        
        @media (max-width: 768px) {
            .sensor-values {
                grid-template-columns: 1fr;
            }
            
            .vr-controls {
                flex-direction: column;
            }
            
            .vr-control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ESP32 MPU6050 BLE - 3D VR Visualization</h1>
            <div id="status" class="status disconnected">
                <span class="indicator offline"></span> –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            </div>
        </div>
        
        <div class="control-panel">
            <h2>üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Bluetooth</h2>
            
            <div class="connection-controls">
                <div class="input-group">
                    <label>–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ BLE:</label>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 5px;">
                        <strong>ESP32_MPU6050</strong>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="scanBtn" class="btn">
                        <span>üîç</span> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button id="connectBtn" class="btn btn-success" disabled>
                        <span>üîó</span> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>
                        <span>‚ùå</span> –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                </div>
                
                <div class="btn-group">
                    <button id="startStreamBtn" class="btn" disabled>
                        <span>üìä</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫
                    </button>
                    <button id="stopStreamBtn" class="btn" disabled>
                        <span>‚è∏Ô∏è</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫
                    </button>
                </div>
            </div>
            
            <div class="zero-controls">
                <h3>üéØ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –Ω–æ–ª—å</h3>
                <div class="zero-status not-set" id="zeroStatus">
                    –ù–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                </div>
                <button id="setZeroBtn" class="btn btn-success" disabled>
                    <span>üéØ</span> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–ª—å
                </button>
                <button id="resetZeroBtn" class="btn btn-warning" disabled>
                    <span>üîÑ</span> –°–±—Ä–æ—Å–∏—Ç—å –Ω–æ–ª—å
                </button>
            </div>
            
            <div class="btn-group">
                <button id="recalibrateBtn" class="btn btn-warning" disabled>
                    <span>üìä</span> –ü–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å
                </button>
                <button id="resetAnglesBtn" class="btn btn-danger" disabled>
                    <span>üóëÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å —É–≥–ª—ã
                </button>
                <button id="getDataBtn" class="btn" disabled>
                    <span>üìà</span> –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button id="toggleLedBtn" class="btn" disabled>
                    <span>üí°</span> LED –í–ö–õ/–í–´–ö–õ
                </button>
            </div>
            
            <div class="log-container">
                <div class="log-title">
                    <span>üìù –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π:</span>
                    <span id="logCount">0 —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                </div>
                <div class="log" id="logContent">
                    <!-- –õ–æ–≥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
                <button id="clearLogBtn" class="btn" style="margin-top: 10px;">
                    <span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
                </button>
            </div>
        </div>
        
        <div class="visualization-panel">
            <div class="vr-info">
                <div>Pitch: <span id="vrPitch">0.00</span>¬∞</div>
                <div>Roll: <span id="vrRoll">0.00</span>¬∞</div>
                <div>Yaw: <span id="vrYaw">0.00</span>¬∞</div>
                <div>–†–µ–∂–∏–º: <span id="vrMode">VR –ì–æ–ª–æ–≤–∞</span></div>
            </div>
            <div class="vr-view">
                <div id="vrScene"></div>
            </div>
            <div class="vr-controls">
                <button id="resetViewBtn" class="btn vr-control-btn">
                    <span>üîÑ</span> –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
                </button>
                <button id="toggleGridBtn" class="btn vr-control-btn">
                    <span>üî≤</span> –°–µ—Ç–∫–∞ –í–ö–õ/–í–´–ö–õ
                </button>
                <button id="toggleAxisBtn" class="btn vr-control-btn">
                    <span>üß≠</span> –û—Å–∏ –í–ö–õ/–í–´–ö–õ
                </button>
            </div>
        </div>
        
        <div class="vr-panel">
            <h2>üìä –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–∞</h2>
            
            <div class="data-item">
                <div class="data-label">
                    <span>Pitch (–ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä—ë–¥/–Ω–∞–∑–∞–¥)</span>
                </div>
                <div class="data-value">
                    <span id="pitchValue">0.00</span><span class="data-unit">¬∞</span>
                </div>
            </div>
            
            <div class="data-item">
                <div class="data-label">
                    <span>Roll (–ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ)</span>
                </div>
                <div class="data-value">
                    <span id="rollValue">0.00</span><span class="data-unit">¬∞</span>
                </div>
            </div>
            
            <div class="data-item">
                <div class="data-label">
                    <span>Yaw (–ü–æ–≤–æ—Ä–æ—Ç –≥–æ–ª–æ–≤—ã)</span>
                </div>
                <div class="data-value">
                    <span id="yawValue">0.00</span><span class="data-unit">¬∞</span>
                </div>
            </div>
            
            <h3 style="margin-top: 20px;">üìà –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã (–æ—Ç –Ω—É–ª—è)</h3>
            
            <div class="sensor-values">
                <div class="sensor-card">
                    <div class="sensor-title">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Pitch</div>
                    <div class="sensor-number" id="relPitchValue">0.00¬∞</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-title">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Roll</div>
                    <div class="sensor-number" id="relRollValue">0.00¬∞</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-title">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Yaw</div>
                    <div class="sensor-number" id="relYawValue">0.00¬∞</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-title">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π Yaw</div>
                    <div class="sensor-number" id="accYawValue">0.00¬∞</div>
                </div>
            </div>
            
            <div class="data-item" style="margin-top: 20px;">
                <div class="data-label">
                    <span>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
                </div>
                <div class="data-value" style="font-size: 18px;">
                    <span id="dataRate">0</span><span class="data-unit"> —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫</span>
                </div>
            </div>
            
            <div class="data-item">
                <div class="data-label">
                    <span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                </div>
                <div class="data-value" style="font-size: 16px;">
                    <span id="lastUpdate">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è BLE
        const BLE_CONFIG = {
            SERVICE_UUID: '4fafc201-1fb5-459e-8fcc-c5c9c331914b',
            CHARACTERISTIC_UUID: 'beb5483e-36e1-4688-b7f5-ea07361b26a8',
            DEVICE_NAME: 'ESP32_MPU6050'
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            device: null,
            server: null,
            service: null,
            characteristic: null,
            isConnected: false,
            isStreaming: false,
            logEntries: 0,
            lastDataTime: 0,
            dataCount: 0,
            dataRate: 0,
            ledState: false,
            sensorData: {
                pitch: 0,
                roll: 0,
                yaw: 0,
                relPitch: 0,
                relRoll: 0,
                relYaw: 0,
                accPitch: 0,
                accRoll: 0,
                accYaw: 0,
                zeroSet: false
            },
            zeroPoint: {
                pitch: 0,
                roll: 0,
                yaw: 0,
                isSet: false
            }
        };

        // 3D Scene variables
        let scene, camera, renderer, cube, axesHelper, gridHelper;
        let controls;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            status: document.getElementById('status'),
            scanBtn: document.getElementById('scanBtn'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            startStreamBtn: document.getElementById('startStreamBtn'),
            stopStreamBtn: document.getElementById('stopStreamBtn'),
            setZeroBtn: document.getElementById('setZeroBtn'),
            resetZeroBtn: document.getElementById('resetZeroBtn'),
            recalibrateBtn: document.getElementById('recalibrateBtn'),
            resetAnglesBtn: document.getElementById('resetAnglesBtn'),
            getDataBtn: document.getElementById('getDataBtn'),
            toggleLedBtn: document.getElementById('toggleLedBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            logContent: document.getElementById('logContent'),
            logCount: document.getElementById('logCount'),
            zeroStatus: document.getElementById('zeroStatus'),
            
            // –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–∞
            pitchValue: document.getElementById('pitchValue'),
            rollValue: document.getElementById('rollValue'),
            yawValue: document.getElementById('yawValue'),
            relPitchValue: document.getElementById('relPitchValue'),
            relRollValue: document.getElementById('relRollValue'),
            relYawValue: document.getElementById('relYawValue'),
            accYawValue: document.getElementById('accYawValue'),
            dataRate: document.getElementById('dataRate'),
            lastUpdate: document.getElementById('lastUpdate'),
            
            // 3D —ç–ª–µ–º–µ–Ω—Ç—ã
            vrScene: document.getElementById('vrScene'),
            vrPitch: document.getElementById('vrPitch'),
            vrRoll: document.getElementById('vrRoll'),
            vrYaw: document.getElementById('vrYaw'),
            vrMode: document.getElementById('vrMode'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            toggleGridBtn: document.getElementById('toggleGridBtn'),
            toggleAxisBtn: document.getElementById('toggleAxisBtn')
        };

        // –£—Ç–∏–ª–∏—Ç—ã
        const utils = {
            getTimeString: () => {
                const now = new Date();
                return now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },
            
            updateLogCount: () => {
                elements.logCount.textContent = `${state.logEntries} —Å–æ–æ–±—â–µ–Ω–∏–π`;
            },
            
            formatNumber: (num, decimals = 2) => {
                return parseFloat(num).toFixed(decimals);
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D —Å—Ü–µ–Ω—ã
        function init3DScene() {
            try {
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a1a2e);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                camera = new THREE.PerspectiveCamera(75, elements.vrScene.offsetWidth / elements.vrScene.offsetHeight, 0.1, 1000);
                camera.position.set(3, 3, 3);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(elements.vrScene.offsetWidth, elements.vrScene.offsetHeight);
                elements.vrScene.appendChild(renderer.domElement);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –æ—Ä–±–∏—Ç—ã
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                
                // –û—Å–≤–µ—â–µ–Ω–∏–µ
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ 3D –º–æ–¥–µ–ª–∏ –≥–æ–ª–æ–≤—ã
                createHeadModel();
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
                gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
                scene.add(gridHelper);
                gridHelper.visible = true;
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Å–µ–π
                axesHelper = new THREE.AxesHelper(2);
                scene.add(axesHelper);
                axesHelper.visible = true;
                
                // –ê–Ω–∏–º–∞—Ü–∏—è
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                window.addEventListener('resize', () => {
                    camera.aspect = elements.vrScene.offsetWidth / elements.vrScene.offsetHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(elements.vrScene.offsetWidth, elements.vrScene.offsetHeight);
                });
                
                logger.info('3D —Å—Ü–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ 3D —Å—Ü–µ–Ω—ã: ${error.message}`);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ 3D –º–æ–¥–µ–ª–∏ –≥–æ–ª–æ–≤—ã
        function createHeadModel() {
            try {
                // –ì–æ–ª–æ–≤–∞ (—Å—Ñ–µ—Ä–∞)
                const headGeometry = new THREE.SphereGeometry(1, 32, 32);
                const headMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x3498db,
                    transparent: true,
                    opacity: 0.8
                });
                const head = new THREE.Mesh(headGeometry, headMaterial);
                
                // –ü—Ä–∞–≤—ã–π "–≥–ª–∞–∑" VR –æ—á–∫–æ–≤
                const rightEyeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 32);
                const rightEyeMaterial = new THREE.MeshPhongMaterial({ color: 0x2ecc71 });
                const rightEye = new THREE.Mesh(rightEyeGeometry, rightEyeMaterial);
                rightEye.position.set(0.4, 0.1, 0.5);
                
                // –õ–µ–≤—ã–π "–≥–ª–∞–∑" VR –æ—á–∫–æ–≤
                const leftEyeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 32);
                const leftEyeMaterial = new THREE.MeshPhongMaterial({ color: 0x2ecc71 });
                const leftEye = new THREE.Mesh(leftEyeGeometry, leftEyeMaterial);
                leftEye.position.set(-0.4, 0.1, 0.5);
                
                // –û–ø—Ä–∞–≤–∞ –æ—á–∫–æ–≤
                const frameGeometry = new THREE.TorusGeometry(0.8, 0.05, 16, 100);
                const frameMaterial = new THREE.MeshPhongMaterial({ color: 0xe74c3c });
                const frame = new THREE.Mesh(frameGeometry, frameMaterial);
                frame.position.z = 0.5;
                
                // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –¥–ª—è –≤—Å–µ–π –º–æ–¥–µ–ª–∏
                cube = new THREE.Group();
                cube.add(head);
                cube.add(rightEye);
                cube.add(leftEye);
                cube.add(frame);
                
                scene.add(cube);
                logger.info('3D –º–æ–¥–µ–ª—å –≥–æ–ª–æ–≤—ã —Å–æ–∑–¥–∞–Ω–∞');
            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è 3D –º–æ–¥–µ–ª–∏: ${error.message}`);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        function update3DVisualization(pitch, roll, yaw) {
            if (!cube) return;
            
            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≥—Ä–∞–¥—É—Å–æ–≤ –≤ —Ä–∞–¥–∏–∞–Ω—ã
                const pitchRad = pitch * (Math.PI / 180);
                const rollRad = roll * (Math.PI / 180);
                const yawRad = yaw * (Math.PI / 180);
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–∞—â–µ–Ω–∏—è (–∫–∞–∫ –≤ WiFi –≤–µ—Ä—Å–∏–∏)
                // –ü–æ—Ä—è–¥–æ–∫: pitch (X), roll (Z), yaw (Y)
                cube.rotation.x = pitchRad;  // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥
                cube.rotation.z = rollRad;   // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ
                cube.rotation.y = yawRad;    // –ü–æ–≤–æ—Ä–æ—Ç –≥–æ–ª–æ–≤—ã
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ HUD
                elements.vrPitch.textContent = utils.formatNumber(pitch);
                elements.vrRoll.textContent = utils.formatNumber(roll);
                elements.vrYaw.textContent = utils.formatNumber(yaw);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logger = {
            add: (message, type = 'info') => {
                const entry = document.createElement('div');
                entry.className = `log-entry`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'log-time';
                timeSpan.textContent = utils.getTimeString();
                
                const messageSpan = document.createElement('span');
                messageSpan.className = `log-message log-${type}`;
                messageSpan.textContent = message;
                
                entry.appendChild(timeSpan);
                entry.appendChild(messageSpan);
                elements.logContent.appendChild(entry);
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                elements.logContent.scrollTop = elements.logContent.scrollHeight;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
                state.logEntries++;
                utils.updateLogCount();
            },
            
            clear: () => {
                elements.logContent.innerHTML = '';
                state.logEntries = 0;
                utils.updateLogCount();
                logger.add('–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', 'info');
            },
            
            error: (message) => logger.add(`‚ùå ${message}`, 'error'),
            info: (message) => logger.add(`‚ÑπÔ∏è ${message}`, 'info'),
            sent: (message) => logger.add(`üì§ ${message}`, 'sent'),
            received: (message) => logger.add(`üì• ${message}`, 'received')
        };

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        const statusManager = {
            set: (message, type) => {
                const indicator = elements.status.querySelector('.indicator');
                if (indicator) {
                    indicator.className = 'indicator ' + (type === 'connected' ? 'online' : 'offline');
                }
                elements.status.textContent = message;
                elements.status.className = `status ${type}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                const isConnected = type === 'connected';
                const isScanning = type === 'scanning';
                
                elements.scanBtn.disabled = isScanning || isConnected;
                elements.connectBtn.disabled = !state.device || isConnected || isScanning;
                elements.disconnectBtn.disabled = !isConnected;
                elements.startStreamBtn.disabled = !isConnected;
                elements.stopStreamBtn.disabled = !isConnected || !state.isStreaming;
                elements.setZeroBtn.disabled = !isConnected;
                elements.resetZeroBtn.disabled = !isConnected;
                elements.recalibrateBtn.disabled = !isConnected;
                elements.resetAnglesBtn.disabled = !isConnected;
                elements.getDataBtn.disabled = !isConnected;
                elements.toggleLedBtn.disabled = !isConnected;
                
                // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º 3D —Å—Ü–µ–Ω—É
                if (isConnected && !scene) {
                    setTimeout(() => {
                        init3DScene();
                    }, 100);
                }
            },
            
            updateZeroStatus: (isSet) => {
                state.zeroPoint.isSet = isSet;
                elements.zeroStatus.textContent = isSet ? '–ù–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                elements.zeroStatus.className = `zero-status ${isSet ? 'set' : 'not-set'}`;
            },
            
            updateStreamingStatus: () => {
                if (state.isStreaming) {
                    elements.startStreamBtn.disabled = true;
                    elements.stopStreamBtn.disabled = false;
                    logger.info('–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                } else {
                    elements.startStreamBtn.disabled = false;
                    elements.stopStreamBtn.disabled = true;
                    logger.info('–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
            },
            
            updateDataRate: () => {
                const now = Date.now();
                if (state.lastDataTime > 0) {
                    const timeDiff = (now - state.lastDataTime) / 1000;
                    if (timeDiff > 0) {
                        state.dataRate = Math.round(state.dataCount / timeDiff);
                        elements.dataRate.textContent = state.dataRate;
                    }
                } else {
                    state.lastDataTime = now;
                }
                state.dataCount++;
            },
            
            updateLedButton: () => {
                elements.toggleLedBtn.innerHTML = state.ledState ? 
                    '<span>üí°</span> LED –í–´–ö–õ' : 
                    '<span>üî¶</span> LED –í–ö–õ';
            }
        };

        // BLE —Ñ—É–Ω–∫—Ü–∏–∏
        const ble = {
            scan: async () => {
                statusManager.set('üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ BLE...', 'scanning');
                logger.info('–ù–∞—á–∏–Ω–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
                
                try {
                    // –û–ø—Ü–∏–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –∏—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –Ω—É–∂–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º
                    const options = {
                        filters: [{ name: BLE_CONFIG.DEVICE_NAME }],
                        optionalServices: [BLE_CONFIG.SERVICE_UUID]
                    };
                    
                    // –ó–∞–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    state.device = await navigator.bluetooth.requestDevice(options);
                    
                    if (!state.device) {
                        throw new Error('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
                    }
                    
                    logger.info(`–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${state.device.name || '–ë–µ–∑—ã–º—è–Ω–Ω–æ–µ'}`);
                    statusManager.set(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${state.device.name || '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'}`, 'disconnected');
                    
                } catch (error) {
                    logger.error(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${error.message}`);
                    statusManager.set('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'disconnected');
                }
            },
            
            connect: async () => {
                if (!state.device) {
                    logger.error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
                    return;
                }
                
                statusManager.set('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É BLE...', 'scanning');
                logger.info(`–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ ${state.device.name || '—É—Å—Ç—Ä–æ–π—Å—Ç–≤—É'}...`);
                
                try {
                    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GATT —Å–µ—Ä–≤–µ—Ä—É
                    state.server = await state.device.gatt.connect();
                    logger.info('GATT —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É–∂–±—ã
                    state.service = await state.server.getPrimaryService(BLE_CONFIG.SERVICE_UUID);
                    logger.info(`–°–ª—É–∂–±–∞ –Ω–∞–π–¥–µ–Ω–∞: ${BLE_CONFIG.SERVICE_UUID}`);
                    
                    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                    state.characteristic = await state.service.getCharacteristic(BLE_CONFIG.CHARACTERISTIC_UUID);
                    logger.info(`–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞–π–¥–µ–Ω–∞: ${BLE_CONFIG.CHARACTERISTIC_UUID}`);
                    
                    // –ß—Ç–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                    const initialValue = await state.characteristic.readValue();
                    const decoder = new TextDecoder();
                    const text = decoder.decode(initialValue);
                    logger.received(`–ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: "${text}"`);
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    state.isConnected = true;
                    statusManager.set(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${state.device.name || '—É—Å—Ç—Ä–æ–π—Å—Ç–≤—É'}`, 'connected');
                    logger.info('–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É!');
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    state.characteristic.addEventListener('characteristicvaluechanged', ble.handleNotification);
                    await state.characteristic.startNotifications();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
                    state.device.addEventListener('gattserverdisconnected', ble.onDisconnected);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
                    setTimeout(() => {
                        if (state.isConnected) {
                            ble.startStream();
                        }
                    }, 1000);
                    
                } catch (error) {
                    logger.error(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`);
                    statusManager.set('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
                    state.isConnected = false;
                }
            },
            
            handleNotification: (event) => {
                const decoder = new TextDecoder();
                const dataString = decoder.decode(event.target.value);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                logger.received(`–ü–æ–ª—É—á–µ–Ω–æ: ${dataString.substring(0, 100)}${dataString.length > 100 ? '...' : ''}`);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ GET_DATA (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è)
                if (dataString.includes('PITCH:') && dataString.includes('ROLL:') && dataString.includes('YAW:')) {
                    ble.parseOrientationData(dataString);
                }
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                else if (dataString === 'ZERO_POINT_SET') {
                    statusManager.updateZeroStatus(true);
                    logger.info('–¢–æ—á–∫–∞ –Ω—É–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                } else if (dataString === 'ZERO_POINT_RESET') {
                    statusManager.updateZeroStatus(false);
                    logger.info('–¢–æ—á–∫–∞ –Ω—É–ª—è —Å–±—Ä–æ—à–µ–Ω–∞');
                } else if (dataString === 'ANGLES_RESET') {
                    logger.info('–í—Å–µ —É–≥–ª—ã —Å–±—Ä–æ—à–µ–Ω—ã');
                } else if (dataString === 'RECALIBRATION_COMPLETE') {
                    logger.info('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                } else if (dataString.includes('LED –≤–∫–ª—é—á–µ–Ω')) {
                    state.ledState = true;
                    statusManager.updateLedButton();
                    logger.info('LED –≤–∫–ª—é—á–µ–Ω');
                } else if (dataString.includes('LED –≤—ã–∫–ª—é—á–µ–Ω')) {
                    state.ledState = false;
                    statusManager.updateLedButton();
                    logger.info('LED –≤—ã–∫–ª—é—á–µ–Ω');
                } else {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ñ–æ—Ä–º–∞—Ç CSV)
                    ble.parseRawData(dataString);
                }
            },
            
            parseOrientationData: (dataString) => {
                try {
                    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑ BLE –≤–µ—Ä—Å–∏–∏
                    const pitchMatch = dataString.match(/PITCH:([-\d.]+)/);
                    const rollMatch = dataString.match(/ROLL:([-\d.]+)/);
                    const yawMatch = dataString.match(/YAW:([-\d.]+)/);
                    const relPitchMatch = dataString.match(/REL_PITCH:([-\d.]+)/);
                    const relRollMatch = dataString.match(/REL_ROLL:([-\d.]+)/);
                    const relYawMatch = dataString.match(/REL_YAW:([-\d.]+)/);
                    const accPitchMatch = dataString.match(/ACC_PITCH:([-\d.]+)/);
                    const accRollMatch = dataString.match(/ACC_ROLL:([-\d.]+)/);
                    const accYawMatch = dataString.match(/ACC_YAW:([-\d.]+)/);
                    const zeroSetMatch = dataString.match(/ZERO_SET:(true|false)/);
                    
                    if (pitchMatch && rollMatch && yawMatch) {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ–Ω—Å–æ—Ä–∞
                        state.sensorData.pitch = parseFloat(pitchMatch[1]);
                        state.sensorData.roll = parseFloat(rollMatch[1]);
                        state.sensorData.yaw = parseFloat(yawMatch[1]);
                        
                        // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã
                        if (relPitchMatch) state.sensorData.relPitch = parseFloat(relPitchMatch[1]);
                        if (relRollMatch) state.sensorData.relRoll = parseFloat(relRollMatch[1]);
                        if (relYawMatch) state.sensorData.relYaw = parseFloat(relYawMatch[1]);
                        
                        // –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
                        if (accPitchMatch) state.sensorData.accPitch = parseFloat(accPitchMatch[1]);
                        if (accRollMatch) state.sensorData.accRoll = parseFloat(accRollMatch[1]);
                        if (accYawMatch) state.sensorData.accYaw = parseFloat(accYawMatch[1]);
                        
                        // –°—Ç–∞—Ç—É—Å –Ω—É–ª—è
                        if (zeroSetMatch) {
                            state.sensorData.zeroSet = zeroSetMatch[1] === 'true';
                            statusManager.updateZeroStatus(state.sensorData.zeroSet);
                        }
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                        visualization.updateSensorDisplay();
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        update3DVisualization(state.sensorData.pitch, state.sensorData.roll, state.sensorData.yaw);
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        elements.lastUpdate.textContent = utils.getTimeString();
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
                        statusManager.updateDataRate();
                    }
                } catch (error) {
                    logger.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                }
            },
            
            parseRawData: (dataString) => {
                try {
                    // –ü–∞—Ä—Å–∏–Ω–≥ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV
                    const parts = dataString.split(',');
                    if (parts.length >= 7) {
                        // –≠—Ç–æ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞/–≥–∏—Ä–æ—Å–∫–æ–ø–∞
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                        logger.received(`–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: ${parts.slice(0, 3).map(p => parseFloat(p).toFixed(2)).join(', ')}...`);
                    }
                } catch (error) {
                    logger.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                }
            },
            
            startStream: async () => {
                if (!state.isConnected) {
                    logger.error('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É');
                    return;
                }
                
                state.isStreaming = true;
                statusManager.updateStreamingStatus();
                logger.info('–ó–∞–ø—É—â–µ–Ω –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞');
            },
            
            stopStream: () => {
                state.isStreaming = false;
                statusManager.updateStreamingStatus();
                logger.info('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞');
            },
            
            disconnect: async () => {
                if (!state.device || !state.isConnected) {
                    return;
                }
                
                try {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
                    if (state.isStreaming) {
                        ble.stopStream();
                    }
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    if (state.characteristic) {
                        await state.characteristic.stopNotifications();
                        state.characteristic.removeEventListener('characteristicvaluechanged', ble.handleNotification);
                    }
                    
                    // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è
                    if (state.device.gatt.connected) {
                        state.device.gatt.disconnect();
                    }
                    
                    state.isConnected = false;
                    state.isStreaming = false;
                    statusManager.set('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'disconnected');
                    logger.info('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
                    
                } catch (error) {
                    logger.error(`–û—Ç–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`);
                }
            },
            
            onDisconnected: () => {
                state.isConnected = false;
                state.isStreaming = false;
                statusManager.set('üîå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–∏–ª–æ—Å—å', 'disconnected');
                logger.info('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–∏–ª–æ—Å—å');
            },
            
            sendCommand: async (command) => {
                if (!state.isConnected || !state.characteristic) {
                    logger.error('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É');
                    return;
                }
                
                // –û—á–∏—Å—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã
                command = command.trim();
                if (!command) {
                    logger.error('–ü—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞');
                    return;
                }
                
                try {
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã
                    const encoder = new TextEncoder();
                    await state.characteristic.writeValue(encoder.encode(command));
                    logger.sent(`–ö–æ–º–∞–Ω–¥–∞: "${command}"`);
                    
                } catch (error) {
                    logger.error(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ${error.message}`);
                }
            }
        };

        // –§—É–Ω–∫—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        const visualization = {
            updateSensorDisplay: () => {
                // –û—Å–Ω–æ–≤–Ω—ã–µ —É–≥–ª—ã
                elements.pitchValue.textContent = utils.formatNumber(state.sensorData.pitch);
                elements.rollValue.textContent = utils.formatNumber(state.sensorData.roll);
                elements.yawValue.textContent = utils.formatNumber(state.sensorData.yaw);
                
                // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã
                elements.relPitchValue.textContent = utils.formatNumber(state.sensorData.relPitch) + '¬∞';
                elements.relRollValue.textContent = utils.formatNumber(state.sensorData.relRoll) + '¬∞';
                elements.relYawValue.textContent = utils.formatNumber(state.sensorData.relYaw) + '¬∞';
                elements.accYawValue.textContent = utils.formatNumber(state.sensorData.accYaw) + '¬∞';
            }
        };

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è BLE
            elements.scanBtn.addEventListener('click', ble.scan);
            elements.connectBtn.addEventListener('click', ble.connect);
            elements.disconnectBtn.addEventListener('click', ble.disconnect);
            elements.startStreamBtn.addEventListener('click', ble.startStream);
            elements.stopStreamBtn.addEventListener('click', ble.stopStream);
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            elements.setZeroBtn.addEventListener('click', () => {
                ble.sendCommand('SET_ZERO');
            });
            
            elements.resetZeroBtn.addEventListener('click', () => {
                ble.sendCommand('RESET_ZERO');
            });
            
            elements.recalibrateBtn.addEventListener('click', () => {
                ble.sendCommand('RECALIBRATE');
            });
            
            elements.resetAnglesBtn.addEventListener('click', () => {
                ble.sendCommand('RESET_ANGLES');
            });
            
            elements.getDataBtn.addEventListener('click', () => {
                ble.sendCommand('GET_DATA');
            });
            
            elements.toggleLedBtn.addEventListener('click', () => {
                ble.sendCommand(state.ledState ? 'LED OFF' : 'LED ON');
            });
            
            elements.clearLogBtn.addEventListener('click', logger.clear);
            
            // –ö–Ω–æ–ø–∫–∏ 3D —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            elements.resetViewBtn.addEventListener('click', () => {
                if (camera && controls) {
                    camera.position.set(3, 3, 3);
                    controls.reset();
                }
                logger.info('–í–∏–¥ 3D —Å—Ü–µ–Ω—ã —Å–±—Ä–æ—à–µ–Ω');
            });
            
            elements.toggleGridBtn.addEventListener('click', () => {
                if (gridHelper) {
                    gridHelper.visible = !gridHelper.visible;
                    logger.info(`–°–µ—Ç–∫–∞ ${gridHelper.visible ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞'}`);
                }
            });
            
            elements.toggleAxisBtn.addEventListener('click', () => {
                if (axesHelper) {
                    axesHelper.visible = !axesHelper.visible;
                    logger.info(`–û—Å–∏ ${axesHelper.visible ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`);
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            logger.info('–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ MPU6050 —á–µ—Ä–µ–∑ BLE –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            logger.info('–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "ESP32_MPU6050"');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Bluetooth
            if (!navigator.bluetooth) {
                logger.error('Web Bluetooth API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                logger.error('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge –Ω–∞ Windows/Mac/Android –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ —Ñ–ª–∞–≥ chrome://flags/#enable-experimental-web-platform-features');
                elements.scanBtn.disabled = true;
                elements.connectBtn.disabled = true;
                statusManager.set('‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Bluetooth', 'disconnected');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebGL
            if (!window.WebGLRenderingContext) {
                logger.warning('WebGL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                logger.warning('3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', initApp);
    </script>
</body>
</html>