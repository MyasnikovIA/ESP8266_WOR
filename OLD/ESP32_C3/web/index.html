<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Head Tracker - Bluetooth MPU6050</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .visualization-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #feca57;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 3D Visualization */
        .cube-container {
            width: 400px;
            height: 400px;
            margin: 0 auto;
            perspective: 1200px;
        }

        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .face {
            position: absolute;
            width: 400px;
            height: 400px;
            border: 4px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
        }

        .front { transform: rotateY(0deg) translateZ(200px); background: rgba(52, 152, 219, 0.7); }
        .back { transform: rotateY(180deg) translateZ(200px); background: rgba(155, 89, 182, 0.7); }
        .right { transform: rotateY(90deg) translateZ(200px); background: rgba(46, 204, 113, 0.7); }
        .left { transform: rotateY(-90deg) translateZ(200px); background: rgba(231, 76, 60, 0.7); }
        .top { transform: rotateX(90deg) translateZ(200px); background: rgba(241, 196, 15, 0.7); }
        .bottom { transform: rotateX(-90deg) translateZ(200px); background: rgba(230, 126, 34, 0.7); }

        /* Data Display */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .data-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .data-item.relative {
            border-left-color: #2ecc71;
        }

        .data-item.accumulated {
            border-left-color: #f39c12;
        }

        .data-label {
            font-size: 0.9em;
            color: #bdc3c7;
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 1.8em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Controls */
        .connection-status {
            background: rgba(231, 76, 60, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e74c3c;
            text-align: center;
        }

        .connection-status.connected {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-commands {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-connect {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-disconnect {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        /* Terminal */
        .terminal {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .terminal-line {
            margin-bottom: 5px;
            word-break: break-all;
        }

        .terminal-line.sent {
            color: #3498db;
        }

        .terminal-line.received {
            color: #2ecc71;
        }

        .terminal-line.system {
            color: #f39c12;
        }

        .terminal-line.error {
            color: #e74c3c;
        }

        /* Zero Status */
        .zero-status {
            background: rgba(243, 156, 18, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #f39c12;
        }

        .zero-status.active {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .cube-container {
                width: 300px;
                height: 300px;
            }
            
            .face {
                width: 300px;
                height: 300px;
                font-size: 22px;
            }
            
            .front, .back, .right, .left, .top, .bottom {
                transform-origin: center;
            }
            
            .front { transform: rotateY(0deg) translateZ(150px); }
            .back { transform: rotateY(180deg) translateZ(150px); }
            .right { transform: rotateY(90deg) translateZ(150px); }
            .left { transform: rotateY(-90deg) translateZ(150px); }
            .top { transform: rotateX(90deg) translateZ(150px); }
            .bottom { transform: rotateX(-90deg) translateZ(150px); }
        }

        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ VR Head Tracker - Bluetooth MPU6050</h1>
            <p>–†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏</p>
        </div>

        <div class="content">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
            <div class="visualization-section">
                <div class="section-title">
                    üéØ 3D –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏—è
                </div>
                
                <div class="cube-container">
                    <div class="cube" id="cube">
                        <div class="face front">–ü–ï–†–ï–î</div>
                        <div class="face back">–ó–ê–î</div>
                        <div class="face right">–ü–†–ê–í–û</div>
                        <div class="face left">–õ–ï–í–û</div>
                        <div class="face top">–í–ï–†–•</div>
                        <div class="face bottom">–ù–ò–ó</div>
                    </div>
                </div>

                <div class="data-grid">
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —É–≥–ª—ã -->
                    <div class="data-item">
                        <div class="data-label">Pitch (–¢–∞–Ω–≥–∞–∂)</div>
                        <div class="data-value" id="pitch">0.0¬∞</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Roll (–ö—Ä–µ–Ω)</div>
                        <div class="data-value" id="roll">0.0¬∞</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Yaw (–†—ã—Å–∫–∞–Ω–∏–µ)</div>
                        <div class="data-value" id="yaw">0.0¬∞</div>
                    </div>
                    
                    <!-- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã -->
                    <div class="data-item relative">
                        <div class="data-label">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Pitch</div>
                        <div class="data-value" id="relPitch">0.0¬∞</div>
                    </div>
                    <div class="data-item relative">
                        <div class="data-label">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Roll</div>
                        <div class="data-value" id="relRoll">0.0¬∞</div>
                    </div>
                    <div class="data-item relative">
                        <div class="data-label">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π Yaw</div>
                        <div class="data-value" id="relYaw">0.0¬∞</div>
                    </div>
                    
                    <!-- –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã -->
                    <div class="data-item accumulated">
                        <div class="data-label">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π Pitch</div>
                        <div class="data-value" id="accPitch">0.0¬∞</div>
                    </div>
                    <div class="data-item accumulated">
                        <div class="data-label">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π Roll</div>
                        <div class="data-value" id="accRoll">0.0¬∞</div>
                    </div>
                    <div class="data-item accumulated">
                        <div class="data-label">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π Yaw</div>
                        <div class="data-value" id="accYaw">0.0¬∞</div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="controls-section">
                <div class="section-title">
                    ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
                </div>

                <div class="connection-status" id="connectionStatus">
                    üî¥ Bluetooth –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                </div>

                <div class="control-buttons">
                    <button class="btn-connect" onclick="connectBluetooth()">
                        üì± –ü–æ–¥–∫–ª—é—á–∏—Ç—å Bluetooth
                    </button>
                    <button class="btn-disconnect" onclick="disconnectBluetooth()">
                        üîå –û—Ç–∫–ª—é—á–∏—Ç—å
                    </button>
                </div>

                <div class="zero-status" id="zeroStatus">
                    ‚ö†Ô∏è –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                </div>

                <div class="section-title">
                    üéÆ –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </div>

                <div class="quick-commands">
                    <button class="btn-primary" onclick="sendCommand('GET_DATA')">
                        üìä –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button class="btn-warning" onclick="sendCommand('RECALIBRATE')">
                        üéØ –ü–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn-info" onclick="sendCommand('SET_ZERO')">
                        üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–ª—å
                    </button>
                    <button class="btn-danger" onclick="sendCommand('RESET_ZERO')">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å –Ω–æ–ª—å
                    </button>
                    <button class="btn-warning" onclick="sendCommand('RESET_ANGLES')">
                        üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —É–≥–ª—ã
                    </button>
                    <button class="btn-info" onclick="sendCommand('STATUS')">
                        ‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                    </button>
                    <button class="btn-primary" onclick="sendCommand('HELP')">
                        ‚ùì –ü–æ–º–æ—â—å
                    </button>
                </div>

                <div class="section-title" style="margin-top: 25px;">
                    üìü –¢–µ—Ä–º–∏–Ω–∞–ª –∫–æ–º–∞–Ω–¥
                </div>

                <div class="terminal" id="terminal">
                    <div class="terminal-line system">>> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</div>
                    <div class="terminal-line system">>> –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É VR_Head_BT</div>
                </div>
            </div>
        </div>
    </div>

<script>
    class SerialManager {
        constructor() {
            this.port = null;
            this.reader = null;
            this.writer = null;
            this.isConnected = false;
            this.isReading = false;
            
            this.cube = document.getElementById('cube');
            this.terminal = document.getElementById('terminal');
            this.connectionStatus = document.getElementById('connectionStatus');
            this.zeroStatus = document.getElementById('zeroStatus');
        }
        
        async connect() {
            try {
                if (!navigator.serial) {
                    throw new Error('Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge 89+.');
                }
                
                this.addTerminalMessage('system', 'üîÑ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ Serial –ø–æ—Ä—Ç—É...');
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ—Ä—Ç
                this.port = await navigator.serial.requestPort();
                
                this.addTerminalMessage('system', 'üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É...');
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–∞–∫ –≤ —Å–∫–µ—Ç—á–µ Arduino
                await this.port.open({
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none'
                });
                
                this.isConnected = true;
                this.updateConnectionStatus();
                this.addTerminalMessage('system', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                this.startReading();
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                setTimeout(() => this.sendCommand('GET_DATA'), 500);
                
            } catch (error) {
                this.addTerminalMessage('error', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                this.isConnected = false;
                this.updateConnectionStatus();
                
                if (error.name === 'NotFoundError') {
                    this.addTerminalMessage('system', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                }
            }
        }
        
        async startReading() {
            if (!this.port || !this.isConnected) return;
            
            try {
                this.isReading = true;
                
                while (this.port.readable && this.isReading) {
                    this.reader = this.port.readable.getReader();
                    
                    try {
                        while (true) {
                            const { value, done } = await this.reader.read();
                            
                            if (done) {
                                break;
                            }
                            
                            if (value) {
                                this.processReceivedData(value);
                            }
                        }
                    } catch (error) {
                        this.addTerminalMessage('error', `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`);
                    } finally {
                        this.reader.releaseLock();
                    }
                }
            } catch (error) {
                this.addTerminalMessage('error', `–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ —á—Ç–µ–Ω–∏—è: ${error.message}`);
            }
        }
        
        processReceivedData(data) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Uint8Array –≤ —Å—Ç—Ä–æ–∫—É
            const text = new TextDecoder().decode(data);
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line === '') continue;
                
                this.addTerminalMessage('received', line);
                this.parseSensorData(line);
            }
        }
        
        async sendCommand(command) {
            if (!this.isConnected || !this.port) {
                this.addTerminalMessage('error', '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã');
                return;
            }
            
            try {
                this.writer = this.port.writable.getWriter();
                const encoder = new TextEncoder();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç Arduino)
                const data = encoder.encode(command + '\n');
                await this.writer.write(data);
                
                this.addTerminalMessage('sent', command);
                
            } catch (error) {
                this.addTerminalMessage('error', `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
            } finally {
                if (this.writer) {
                    this.writer.releaseLock();
                    this.writer = null;
                }
            }
        }
        
        async disconnect() {
            this.isReading = false;
            
            if (this.reader) {
                try {
                    await this.reader.cancel();
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —á—Ç–µ–Ω–∏—è:', error);
                }
                this.reader = null;
            }
            
            if (this.writer) {
                try {
                    this.writer.releaseLock();
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ writer:', error);
                }
                this.writer = null;
            }
            
            if (this.port) {
                try {
                    await this.port.close();
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ—Ä—Ç–∞:', error);
                }
                this.port = null;
            }
            
            this.isConnected = false;
            this.updateConnectionStatus();
            this.addTerminalMessage('system', 'üîå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
        }
        
        parseSensorData(data) {
            try {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –æ—Ç Arduino
                
                if (data.includes('PITCH:') && data.includes('ROLL:') && data.includes('YAW:')) {
                    // –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–∞
                    const pitchMatch = data.match(/PITCH:([-\d.]+)/);
                    const rollMatch = data.match(/ROLL:([-\d.]+)/);
                    const yawMatch = data.match(/YAW:([-\d.]+)/);
                    const relPitchMatch = data.match(/REL_PITCH:([-\d.]+)/);
                    const relRollMatch = data.match(/REL_ROLL:([-\d.]+)/);
                    const relYawMatch = data.match(/REL_YAW:([-\d.]+)/);
                    const accPitchMatch = data.match(/ACC_PITCH:([-\d.]+)/);
                    const accRollMatch = data.match(/ACC_ROLL:([-\d.]+)/);
                    const accYawMatch = data.match(/ACC_YAW:([-\d.]+)/);
                    const zeroSetMatch = data.match(/ZERO_SET:(true|false)/);
                    
                    if (pitchMatch && rollMatch && yawMatch) {
                        const pitch = parseFloat(pitchMatch[1]);
                        const roll = parseFloat(rollMatch[1]);
                        const yaw = parseFloat(yawMatch[1]);
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                        document.getElementById('pitch').textContent = pitch.toFixed(1) + '¬∞';
                        document.getElementById('roll').textContent = roll.toFixed(1) + '¬∞';
                        document.getElementById('yaw').textContent = yaw.toFixed(1) + '¬∞';
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        this.update3DVisualization(pitch, roll, yaw);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã
                    if (relPitchMatch) {
                        document.getElementById('relPitch').textContent = parseFloat(relPitchMatch[1]).toFixed(2) + '¬∞';
                    }
                    if (relRollMatch) {
                        document.getElementById('relRoll').textContent = parseFloat(relRollMatch[1]).toFixed(2) + '¬∞';
                    }
                    if (relYawMatch) {
                        document.getElementById('relYaw').textContent = parseFloat(relYawMatch[1]).toFixed(2) + '¬∞';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
                    if (accPitchMatch) {
                        document.getElementById('accPitch').textContent = parseFloat(accPitchMatch[1]).toFixed(2) + '¬∞';
                    }
                    if (accRollMatch) {
                        document.getElementById('accRoll').textContent = parseFloat(accRollMatch[1]).toFixed(2) + '¬∞';
                    }
                    if (accYawMatch) {
                        document.getElementById('accYaw').textContent = parseFloat(accYawMatch[1]).toFixed(2) + '¬∞';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω—É–ª–µ–≤–æ–π —Ç–æ—á–∫–∏
                    if (zeroSetMatch) {
                        const zeroSet = zeroSetMatch[1] === 'true';
                        this.zeroStatus.innerHTML = zeroSet ? 
                            '‚úÖ –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '‚ö†Ô∏è –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                        this.zeroStatus.className = zeroSet ? 'zero-status active' : 'zero-status';
                    }
                    
                } else if (data.includes('ZERO_SET')) {
                    this.zeroStatus.innerHTML = '‚úÖ –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                    this.zeroStatus.className = 'zero-status active';
                    this.showNotification('–ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                    
                } else if (data.includes('ZERO_RESET')) {
                    this.zeroStatus.innerHTML = '‚ö†Ô∏è –ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                    this.zeroStatus.className = 'zero-status';
                    this.showNotification('–ù—É–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'info');
                    
                } else if (data.includes('SYSTEM_READY')) {
                    this.addTerminalMessage('system', '‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
                    this.showNotification('–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞', 'success');
                    
                } else if (data.includes('RECALIBRATION_COMPLETE')) {
                    this.addTerminalMessage('system', '‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    this.showNotification('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                    
                } else if (data.includes('ANGLES_RESET')) {
                    this.addTerminalMessage('system', '‚úÖ –£–≥–ª—ã —Å–±—Ä–æ—à–µ–Ω—ã');
                    this.showNotification('–£–≥–ª—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
                    
                } else if (data.includes('ERROR:')) {
                    this.addTerminalMessage('error', data);
                    this.showNotification(data.replace('ERROR:', '–û—à–∏–±–∫–∞:'), 'error');
                    
                } else if (data.includes('STATUS:')) {
                    this.addTerminalMessage('system', data.replace('STATUS:', '–°—Ç–∞—Ç—É—Å:'));
                }
                
            } catch (error) {
                this.addTerminalMessage('error', `–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }
        
        update3DVisualization(pitch, roll, yaw) {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –∫ 3D –∫—É–±—É
            // –ü–æ—Ä—è–¥–æ–∫ –≤—Ä–∞—â–µ–Ω–∏—è –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            this.cube.style.transform = 
                `rotateX(${-roll}deg) rotateY(${-yaw}deg) rotateZ(${pitch}deg)`;
        }
        
        addTerminalMessage(type, message) {
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            
            this.terminal.appendChild(line);
            this.terminal.scrollTop = this.terminal.scrollHeight;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
            const lines = this.terminal.getElementsByClassName('terminal-line');
            if (lines.length > 100) {
                this.terminal.removeChild(lines[0]);
            }
        }
        
        updateConnectionStatus() {
            if (this.isConnected) {
                this.connectionStatus.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ VR_Head_BT';
                this.connectionStatus.className = 'connection-status connected';
            } else {
                this.connectionStatus.textContent = 'üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                this.connectionStatus.className = 'connection-status';
            }
        }
        
        showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                border-left: 5px solid ${type === 'success' ? '#2ecc71' : type === 'error' ? '#c0392b' : '#2980b9'};
            `;
            
            document.body.appendChild(notification);
            
            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç Serial –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    const serialManager = new SerialManager();

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    async function connectBluetooth() {
        await serialManager.connect();
    }

    async function disconnectBluetooth() {
        await serialManager.disconnect();
    }

    function sendCommand(command) {
        if (serialManager.isConnected) {
            serialManager.sendCommand(command);
        } else {
            alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É');
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Serial API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', function() {
        if (!navigator.serial) {
            serialManager.addTerminalMessage('error', 
                'Web Serial API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome 89+ –∏–ª–∏ Edge 89+ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É.');
            serialManager.addTerminalMessage('system', 
                '–†–µ–∂–∏–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
            
            setTimeout(() => {
                startDemoMode();
            }, 5000);
        } else {
            serialManager.addTerminalMessage('system', 
                '‚úÖ Web Serial API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å Bluetooth" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.');
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Serial)
    function startDemoMode() {
        const demoManager = new SerialManager();
        demoManager.addTerminalMessage('system', 'üö® –ó–∞–ø—É—Å–∫ –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞');
        demoManager.isConnected = true;
        demoManager.updateConnectionStatus();
        
        let demoPitch = 0, demoRoll = 0, demoYaw = 0;
        
        // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        setInterval(() => {
            demoPitch += (Math.random() - 0.5) * 2;
            demoRoll += (Math.random() - 0.5) * 2;
            demoYaw += (Math.random() - 0.5) * 3;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —É–≥–ª—ã
            demoPitch = Math.max(-180, Math.min(180, demoPitch));
            demoRoll = Math.max(-180, Math.min(180, demoRoll));
            demoYaw = Math.max(-180, Math.min(180, demoYaw));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            document.getElementById('pitch').textContent = demoPitch.toFixed(1) + '¬∞';
            document.getElementById('roll').textContent = demoRoll.toFixed(1) + '¬∞';
            document.getElementById('yaw').textContent = demoYaw.toFixed(1) + '¬∞';
            
            demoManager.update3DVisualization(demoPitch, demoRoll, demoYaw);
            
        }, 100);
    }
</script>
</body>
</html>